<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendario Aste - Real Estate 2.0</title>
  <style>
    /* Stili globali */
    body {
      font-family: Arial, sans-serif;
      background-color: #f2f2f2;
      margin: 20px;
      padding: 0;
    }
    h1, h2, h3 {
      text-align: center;
      margin: 10px 0;
    }
    /* Navigazione per i mesi */
    #calendarNavigation {
      text-align: center;
      margin-bottom: 10px;
    }
    #calendarNavigation button {
      padding: 8px 16px;
      margin: 0 5px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #calendarNavigation button:hover {
      background-color: #0056b3;
    }
    /* Calendario */
    #calendarContainer {
      margin-bottom: 20px;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      min-width: 40px;
    }
    .auction-day {
      background-color: #ffeb3b;
      font-weight: bold;
      cursor: pointer;
    }
    /* Evidenziazione del giorno corrente in verde chiaro */
    .current-day {
      background-color: #90EE90 !important;
      color: #000;
    }
    /* Dettagli Asta */
    #auctionDetails {
      background-color: #fff;
      padding: 15px;
      border: 1px solid #ccc;
      margin-bottom: 20px;
    }
    .auction-item {
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
      margin-bottom: 10px;
    }
    .auction-item button {
      padding: 6px 12px;
      background-color: #dc3545;
      border: none;
      color: #fff;
      cursor: pointer;
      border-radius: 4px;
      margin-right: 5px;
    }
    .auction-item button:hover {
      background-color: #c82333;
    }
    /* Bottone Toggle per Nuova Asta */
    #toggleFormBtn {
      display: block;
      margin: 0 auto 20px auto;
      padding: 10px 20px;
      background-color: #17a2b8;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #toggleFormBtn:hover {
      background-color: #138496;
    }
    /* Form per Nuova Asta e Modifica Asta */
    #newAuctionForm,
    #editAuctionForm {
      display: none; /* Nascosti inizialmente */
      background-color: #fff;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    form div {
      margin-bottom: 10px;
    }
    label {
      display: block;
      margin-bottom: 4px;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    /* Media Query per dispositivi mobili */
    @media (max-width: 600px) {
      body {
        margin: 10px;
      }
      th, td {
        padding: 6px;
        font-size: 12px;
      }
      input, textarea {
        font-size: 14px;
      }
      #toggleFormBtn, #calendarNavigation button {
        padding: 8px 16px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <h1>Calendario Aste - Real Estate 2.0</h1>
  
  <!-- Navigazione tra mesi -->
  <div id="calendarNavigation">
    <button id="prevMonthBtn">Mese Precedente</button>
    <button id="nextMonthBtn">Mese Successivo</button>
  </div>
  
  <!-- Calendario -->
  <div id="calendarContainer">
    <h2 id="monthYear"></h2>
    <table>
      <thead>
        <tr>
          <th>Domenica</th>
          <th>Lunedì</th>
          <th>Martedì</th>
          <th>Mercoledì</th>
          <th>Giovedì</th>
          <th>Venerdì</th>
          <th>Sabato</th>
        </tr>
      </thead>
      <tbody id="calendarBody"></tbody>
    </table>
  </div>
  
  <!-- Dettagli Asta -->
  <div id="auctionDetails">
    <h2>Dettagli Asta</h2>
    <div id="detailsContent">
      <p>Seleziona un giorno per visualizzare i dettagli delle aste.</p>
    </div>
  </div>
  
  <!-- Bottone per mostrare/nascondere il form Nuova Asta -->
  <button id="toggleFormBtn">Nuova Asta</button>
  
  <!-- Form per Nuova Asta -->
  <div id="newAuctionForm">
    <h2>Aggiungi Nuova Asta</h2>
    <form id="auctionForm">
      <div>
        <label for="auctionDate">Data Asta (gg/mm/aaaa):</label>
        <input type="text" id="auctionDate" placeholder="gg/mm/aaaa" pattern="\d{2}/\d{2}/\d{4}" required>
      </div>
      <div>
        <label for="auctionCity">Località:</label>
        <input type="text" id="auctionCity" placeholder="Città" required>
      </div>
      <div>
        <label for="auctionAddress">Indirizzo:</label>
        <input type="text" id="auctionAddress" placeholder="Indirizzo" required>
      </div>
      <div>
        <label for="auctionBasePrice">Prezzo Base Asta (€):</label>
        <input type="number" id="auctionBasePrice" placeholder="Prezzo Base" required>
      </div>
      <div>
        <label for="auctionDeposit">Minimo Bonifico (€):</label>
        <input type="number" id="auctionDeposit" placeholder="Minimo Bonifico" required>
      </div>
      <div>
        <label for="auctionCommercialPrice">Prezzo medio commerciale al mq (€):</label>
        <input type="number" id="auctionCommercialPrice" placeholder="Prezzo medio commerciale al mq" required>
      </div>
      <div>
        <label for="auctionMqPrice">Prezzo al mq in asta (€):</label>
        <input type="number" id="auctionMqPrice" placeholder="Prezzo al mq in asta" required>
      </div>
      <div>
        <label for="auctionDetailsText">Dettagli:</label>
        <textarea id="auctionDetailsText" placeholder="Dettagli" required></textarea>
      </div>
      <div>
        <label for="auctionMapsLink">Link Google Maps:</label>
        <input type="url" id="auctionMapsLink" placeholder="https://www.google.com/maps/..." required>
      </div>
      <div>
        <label for="auctionAstaLink">Link Asta:</label>
        <input type="url" id="auctionAstaLink" placeholder="Inserisci il link custom per l'asta">
      </div>
      <div>
        <label for="auctionImmobiliareLink">Link immobiliare.it:</label>
        <input type="url" id="auctionImmobiliareLink" placeholder="https://www.immobiliare.it/...">
      </div>
      <button type="submit">Aggiungi Asta</button>
    </form>
  </div>
  
  <!-- Form per Modifica Asta -->
  <div id="editAuctionForm">
    <h2>Modifica Asta</h2>
    <form id="editForm">
      <div>
        <label for="editAuctionDate">Data Asta (gg/mm/aaaa):</label>
        <input type="text" id="editAuctionDate" placeholder="gg/mm/aaaa" pattern="\d{2}/\d{2}/\d{4}" required>
      </div>
      <div>
        <label for="editAuctionCity">Località:</label>
        <input type="text" id="editAuctionCity" placeholder="Città" required>
      </div>
      <div>
        <label for="editAuctionAddress">Indirizzo:</label>
        <input type="text" id="editAuctionAddress" placeholder="Indirizzo" required>
      </div>
      <div>
        <label for="editAuctionBasePrice">Prezzo Base Asta (€):</label>
        <input type="number" id="editAuctionBasePrice" placeholder="Prezzo Base" required>
      </div>
      <div>
        <label for="editAuctionDeposit">Minimo Bonifico (€):</label>
        <input type="number" id="editAuctionDeposit" placeholder="Minimo Bonifico" required>
      </div>
      <div>
        <label for="editAuctionCommercialPrice">Prezzo medio commerciale al mq (€):</label>
        <input type="number" id="editAuctionCommercialPrice" placeholder="Prezzo medio commerciale al mq" required>
      </div>
      <div>
        <label for="editAuctionMqPrice">Prezzo al mq in asta (€):</label>
        <input type="number" id="editAuctionMqPrice" placeholder="Prezzo al mq in asta" required>
      </div>
      <div>
        <label for="editAuctionDetailsText">Dettagli:</label>
        <textarea id="editAuctionDetailsText" placeholder="Dettagli" required></textarea>
      </div>
      <div>
        <label for="editAuctionMapsLink">Link Google Maps:</label>
        <input type="url" id="editAuctionMapsLink" placeholder="https://www.google.com/maps/..." required>
      </div>
      <div>
        <label for="editAuctionAstaLink">Link Asta:</label>
        <input type="url" id="editAuctionAstaLink" placeholder="Inserisci il link custom per l'asta">
      </div>
      <div>
        <label for="editAuctionImmobiliareLink">Link immobiliare.it:</label>
        <input type="url" id="editAuctionImmobiliareLink" placeholder="https://www.immobiliare.it/...">
      </div>
      <button type="submit">Salva Modifiche</button>
      <button type="button" id="cancelEditBtn">Annulla</button>
    </form>
  </div>
  
  <!-- Firebase e Script dell'App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    
    // Firebase configuration fornita
    const firebaseConfig = {
      apiKey: "AIzaSyAYHQQe734DukRSMNLZOWSujXA5tcuStqM",
      authDomain: "realestate-2point0.firebaseapp.com",
      projectId: "realestate-2point0",
      storageBucket: "realestate-2point0.firebasestorage.app",
      messagingSenderId: "630032113182",
      appId: "1:630032113182:web:def123b7baac81dd41180f",
      measurementId: "G-VHS8DWRV09"
    };
    
    const appFirebase = initializeApp(firebaseConfig);
    const db = getFirestore(appFirebase);
    
    let auctionsData = [];
    let editingAuctionId = null;
    const monthYearLabel = document.getElementById("monthYear");
    const calendarBody = document.getElementById("calendarBody");
    const detailsContent = document.getElementById("detailsContent");
    const toggleFormBtn = document.getElementById("toggleFormBtn");
    const newAuctionFormDiv = document.getElementById("newAuctionForm");
    const editAuctionFormDiv = document.getElementById("editAuctionForm");
    const months = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
    let today = new Date();
    let currentMonth = today.getMonth();
    let currentYear = today.getFullYear();
    
    async function loadAuctions() {
      const querySnapshot = await getDocs(collection(db, "auctions"));
      let data = [];
      querySnapshot.forEach(docSnap => {
        data.push({ id: docSnap.id, ...docSnap.data() });
      });
      return data;
    }
    
    async function saveAuction(auctionData) {
      try {
        await addDoc(collection(db, "auctions"), auctionData);
      } catch (e) {
        console.error("Errore durante il salvataggio:", e);
      }
    }
    
    async function updateAuction(auctionId, updatedData) {
      try {
        await updateDoc(doc(db, "auctions", auctionId), updatedData);
      } catch (e) {
        console.error("Errore durante l'aggiornamento:", e);
      }
    }
    
    async function removeAuctionFirebase(auctionId) {
      try {
        await deleteDoc(doc(db, "auctions", auctionId));
      } catch (e) {
        console.error("Errore durante l'eliminazione:", e);
      }
    }
    
    function generateCalendar(month, year) {
      monthYearLabel.innerText = months[month] + " " + year;
      calendarBody.innerHTML = "";
      let firstDay = new Date(year, month, 1).getDay();
      let daysInMonth = new Date(year, month + 1, 0).getDate();
      let date = 1;
      for (let i = 0; i < 6; i++) {
        let row = document.createElement("tr");
        for (let j = 0; j < 7; j++) {
          let cell = document.createElement("td");
          if (i === 0 && j < firstDay) {
            cell.innerHTML = "";
          } else if (date > daysInMonth) {
            break;
          } else {
            cell.innerText = date;
            let currentDate = `${String(date).padStart(2, '0')}/${String(month + 1).padStart(2, '0')}/${year}`;
            if (year === today.getFullYear() && month === today.getMonth() && date === today.getDate()) {
              cell.classList.add("current-day");
            }
            const auctionsOnDay = auctionsData.filter(a => a.date === currentDate);
            if (auctionsOnDay.length > 0) {
              cell.classList.add("auction-day");
              cell.dataset.auctions = JSON.stringify(auctionsOnDay);
              cell.addEventListener("click", () => showAuctionDetails(currentDate));
            }
            date++;
          }
          row.appendChild(cell);
        }
        calendarBody.appendChild(row);
      }
    }
    
    function showAuctionDetails(dateStr) {
      const auctionsOnDay = auctionsData.filter(a => a.date === dateStr);
      if (auctionsOnDay.length === 0) {
        detailsContent.innerHTML = `<p>Nessuna asta prevista per il giorno ${dateStr}.</p>`;
        return;
      }
      let html = `<h3>Aste per il ${dateStr}</h3>`;
      auctionsOnDay.forEach(a => {
        html += `<div class="auction-item">
          <h3>${a.city}</h3>
          <p>
            <strong>Indirizzo:</strong> ${a.address} 
            <a href="${a.mapsLink}" target="_blank" title="Apri su Google Maps">🗺️</a>
            ${ a.astaLink ? `<a href="${a.astaLink}" target="_blank" title="Apri link asta">🔨</a>` : "" }
            ${ a.immobiliareLink ? `<a href="${a.immobiliareLink}" target="_blank" title="Apri immobiliare.it">🏠</a>` : "" }
          </p>
          <p><strong>Prezzo Base Asta:</strong> € ${a.basePrice.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
          <p><strong>Minimo Bonifico:</strong> € ${a.deposit.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
          <p><strong>Prezzo medio commerciale al mq:</strong> € ${a.prezzoMedioCommercialeMq.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
          <p><strong>Prezzo al mq in asta:</strong> € ${a.prezzoMqAsta.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
          <p><strong>Dettagli:</strong> ${a.details}</p>
          <button onclick="removeAuction('${a.id}')">Rimuovi Asta</button>
          <button onclick="editAuction('${a.id}')">Modifica Dati</button>
        </div>`;
      });
      detailsContent.innerHTML = html;
    }
    
    async function removeAuction(id) {
      await removeAuctionFirebase(id);
      auctionsData = await loadAuctions();
      generateCalendar(currentMonth, currentYear);
      detailsContent.innerHTML = `<p>Asta rimossa.</p>`;
    }
    
    document.getElementById("prevMonthBtn").addEventListener("click", function() {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      generateCalendar(currentMonth, currentYear);
    });
    
    document.getElementById("nextMonthBtn").addEventListener("click", function() {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      generateCalendar(currentMonth, currentYear);
    });
    
    toggleFormBtn.addEventListener("click", () => {
      if (newAuctionFormDiv.style.display === "none" || newAuctionFormDiv.style.display === "") {
        newAuctionFormDiv.style.display = "block";
        toggleFormBtn.innerText = "Nascondi il form";
      } else {
        newAuctionFormDiv.style.display = "none";
        toggleFormBtn.innerText = "Nuova Asta";
      }
    });
    
    document.getElementById("auctionForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const inputDate = document.getElementById("auctionDate").value;
      if (!inputDate.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
        alert("Inserisci la data nel formato gg/mm/aaaa");
        return;
      }
      const newAuction = {
        date: inputDate,
        city: document.getElementById("auctionCity").value,
        address: document.getElementById("auctionAddress").value,
        basePrice: parseFloat(document.getElementById("auctionBasePrice").value),
        deposit: parseFloat(document.getElementById("auctionDeposit").value),
        prezzoMedioCommercialeMq: parseFloat(document.getElementById("auctionCommercialPrice").value),
        prezzoMqAsta: parseFloat(document.getElementById("auctionMqPrice").value),
        details: document.getElementById("auctionDetailsText").value,
        mapsLink: document.getElementById("auctionMapsLink").value,
        astaLink: document.getElementById("auctionAstaLink").value,
        immobiliareLink: document.getElementById("auctionImmobiliareLink").value
      };
      await saveAuction(newAuction);
      auctionsData = await loadAuctions();
      generateCalendar(currentMonth, currentYear);
      alert("Asta aggiunta con successo!");
      e.target.reset();
    });
    
    function editAuction(id) {
      editingAuctionId = id;
      const auction = auctionsData.find(a => a.id === id);
      if (!auction) return;
      document.getElementById("editAuctionDate").value = auction.date;
      document.getElementById("editAuctionCity").value = auction.city;
      document.getElementById("editAuctionAddress").value = auction.address;
      document.getElementById("editAuctionBasePrice").value = auction.basePrice;
      document.getElementById("editAuctionDeposit").value = auction.deposit;
      document.getElementById("editAuctionCommercialPrice").value = auction.prezzoMedioCommercialeMq;
      document.getElementById("editAuctionMqPrice").value = auction.prezzoMqAsta;
      document.getElementById("editAuctionDetailsText").value = auction.details;
      document.getElementById("editAuctionMapsLink").value = auction.mapsLink;
      document.getElementById("editAuctionAstaLink").value = auction.astaLink;
      document.getElementById("editAuctionImmobiliareLink").value = auction.immobiliareLink;
      editAuctionFormDiv.style.display = "block";
      newAuctionFormDiv.style.display = "none";
      toggleFormBtn.innerText = "Nuova Asta";
    }
    
    document.getElementById("editForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      if (!editingAuctionId) return;
      const updatedData = {
        date: document.getElementById("editAuctionDate").value,
        city: document.getElementById("editAuctionCity").value,
        address: document.getElementById("editAuctionAddress").value,
        basePrice: parseFloat(document.getElementById("editAuctionBasePrice").value),
        deposit: parseFloat(document.getElementById("editAuctionDeposit").value),
        prezzoMedioCommercialeMq: parseFloat(document.getElementById("editAuctionCommercialPrice").value),
        prezzoMqAsta: parseFloat(document.getElementById("editAuctionMqPrice").value),
        details: document.getElementById("editAuctionDetailsText").value,
        mapsLink: document.getElementById("editAuctionMapsLink").value,
        astaLink: document.getElementById("editAuctionAstaLink").value,
        immobiliareLink: document.getElementById("editAuctionImmobiliareLink").value
      };
      await updateAuction(editingAuctionId, updatedData);
      auctionsData = await loadAuctions();
      generateCalendar(currentMonth, currentYear);
      alert("Asta modificata con successo!");
      editAuctionFormDiv.style.display = "none";
    });
    
    document.getElementById("cancelEditBtn").addEventListener("click", function() {
      editingAuctionId = null;
      editAuctionFormDiv.style.display = "none";
    });
    
    async function initializeApp() {
      auctionsData = await loadAuctions();
      generateCalendar(currentMonth, currentYear);
    }
    
    initializeApp();
  </script>
</body>
</html>
